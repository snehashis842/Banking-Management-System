{% extends "base.html" %} {% block title %}Add User - Bank Management System{%
endblock %} {% block content %}
<div class="card">
  <div class="nav-links">
    <a href="/dashboard">‚Üê Back to Dashboard</a>
    <a href="/view_users">View All Users</a>
  </div>

  <h2>Add New User</h2>

  <form id="addUserForm">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px">
      <div class="form-group">
        <label for="firstName">First Name:</label>
        <input type="text" id="firstName" name="First_Name" required />
      </div>

      <div class="form-group">
        <label for="lastName">Last Name:</label>
        <input type="text" id="lastName" name="Last_Name" required />
      </div>
    </div>

    <div class="form-group">
      <label for="email">Email Address:</label>
      <input type="email" id="email" name="EmailID" required />
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px">
      <div class="form-group">
        <label for="dob">Date of Birth:</label>
        <input
          type="date"
          id="dob"
          name="DOB"
          max="2010-12-31"
          min="1950-01-01"
          required
        />
      </div>

      <div class="form-group">
        <label for="phone">Phone Number:</label>
        <input
          type="tel"
          id="phone"
          name="PhoneNo"
          placeholder="1234567890"
          pattern="\d{10}"
          required
        />
      </div>
    </div>

    <div class="form-group">
      <label for="gender">Gender:</label>
      <select id="gender" name="Gender" required>
        <option value="">Select Gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
      </select>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px">
      <div class="form-group">
        <label for="state">State:</label>
        <select id="state" name="State" required>
          <option value="">Select State</option>
        </select>
      </div>

      <div class="form-group">
        <label for="city">City:</label>
        <select id="city" name="City" required>
          <option value="">Select State First</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="address">Street Address (Optional):</label>
      <input
        type="text"
        id="address"
        name="StreetAddress"
        placeholder="House/Building number, Street name"
      />
    </div>

    <div class="form-group">
      <label for="role">Role:</label>
      <select id="role" name="Role" required>
        <option value="">Select Role</option>
      </select>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 30px">
      <button type="submit" class="btn btn-success">Add User</button>
      <button type="reset" class="btn">Clear Form</button>
    </div>
  </form>

  <div id="message"></div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document
    .getElementById("addUserForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = "Adding User...";
      submitBtn.disabled = true;

      const formData = new FormData(this);
      // Construct address from state, city, and street address
      const state = formData.get("State");
      const city = formData.get("City");
      const streetAddress = formData.get("StreetAddress") || "";
      const fullAddress = streetAddress
        ? `${streetAddress}, ${city}, ${state}`
        : `${city}, ${state}`;

      // Convert date from YYYY-MM-DD to DD-MM-YYYY format
      const dobInput = formData.get("DOB");
      const dobFormatted = dobInput
        ? dobInput.split("-").reverse().join("-")
        : "";

      const userData = {
        First_Name: formData.get("First_Name"),
        Last_Name: formData.get("Last_Name"),
        EmailID: formData.get("EmailID"),
        DOB: dobFormatted,
        PhoneNo: [formData.get("PhoneNo")], // Convert to array as expected by backend
        Gender: formData.get("Gender"),
        Address: fullAddress,
        Role: formData.get("Role"),
      }; // UserId is auto-generated by the backend

      try {
        const response = await fetch("/add_user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(userData),
        });

        const result = await response.json();

        if (response.ok) {
          showSuccess(
            "message",
            `User added successfully!<br><strong>User ID:</strong> ${result.UserId}<br><strong>Generated Password:</strong> ${result.GeneratedPassword}<br><em>Please save this information and share it with the user.</em>`
          );
          this.reset();
        } else {
          if (handleAuthError(response)) {
            showError("message", `Access denied: ${result.detail}`);
            return;
          }
          showError("message", result.detail);
        }
      } catch (error) {
        showError("message", `Network error: ${error.message}`);
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

  // Add input validation for phone number
  document.getElementById("phone").addEventListener("input", function (e) {
    const value = e.target.value;
    if (value && !/^\d{10}$/.test(value)) {
      e.target.setCustomValidity("Phone number must be exactly 10 digits");
    } else {
      e.target.setCustomValidity("");
    }
  });

  // Load roles on page load
  async function loadRoles() {
    try {
      const response = await fetch("/get_roles");
      if (response.ok) {
        const data = await response.json();
        const roleSelect = document.getElementById("role");

        data.roles.forEach((role) => {
          const option = document.createElement("option");
          option.value = role.role_name;
          option.textContent = role.role_name.replace("_", " ");
          roleSelect.appendChild(option);
        });
      }
    } catch (error) {
      console.error("Failed to load roles:", error);
    }
  }

  // Load states on page load
  async function loadStates() {
    try {
      const response = await fetch("/get_states");
      if (response.ok) {
        const data = await response.json();
        const stateSelect = document.getElementById("state");

        data.states.forEach((state) => {
          const option = document.createElement("option");
          option.value = state;
          option.textContent = state;
          stateSelect.appendChild(option);
        });
      }
    } catch (error) {
      console.error("Failed to load states:", error);
    }
  }

  // Load cities when state is selected
  async function loadCities(state) {
    const citySelect = document.getElementById("city");
    citySelect.innerHTML = '<option value="">Loading cities...</option>';

    try {
      const response = await fetch(`/get_cities/${encodeURIComponent(state)}`);
      if (response.ok) {
        const data = await response.json();
        citySelect.innerHTML = '<option value="">Select City</option>';

        data.cities.forEach((city) => {
          const option = document.createElement("option");
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });
      } else {
        citySelect.innerHTML = '<option value="">Error loading cities</option>';
      }
    } catch (error) {
      console.error("Failed to load cities:", error);
      citySelect.innerHTML = '<option value="">Error loading cities</option>';
    }
  }

  // Handle state selection change
  document.getElementById("state").addEventListener("change", function (e) {
    const selectedState = e.target.value;
    if (selectedState) {
      loadCities(selectedState);
    } else {
      document.getElementById("city").innerHTML =
        '<option value="">Select State First</option>';
    }
  });

  // Load data when page loads
  document.addEventListener("DOMContentLoaded", function () {
    loadRoles();
    loadStates();
  });
</script>
{% endblock %}
